<?php
$this->css(
    [
        $this->assetModule('css/front.css')                  => ['defer' => 'defer'],
        $this->assetModule('script/system-ui.css', 'system') => ['defer' => 'defer'],
    ]
);
$this->jQuery();
$this->backbone();
$script
        = <<<'EOT'
(function($) {
    var page = {
        el: $('#js-order'),
        $: function(selector) {
            return this.el.find(selector);
        },
        init: function() {
            _.bindAll(this);
            this.$('#select-location').on("change",this.locationAction);
            this.$('#select-delivery').on("change",this.deliveryAction);
            this.$('#select-payment').on("change",this.paymentAction);
            this.$('.showNewAddressFrom').on("click",this.newAddressAction);
        },
        locationAction: function(e) {
            console.log($('#select-location').val());
            var url = "%s/";
            $.getJSON(url + $('#select-location').val()).done(function(result) {
                if (result.status == 1) {
                    var htmlOptins = '';
                    $.each(result.data, function( index, value ) {
                        if (value.status==1) {
                            htmlOptins = htmlOptins
                                + "<option value='" + value.delivery + "'>"
                                + value.title + " - "
                                + " %s " + value.price + " - "
                                + " %s " + value.delivery_time  + " %s "
                                + "</option>";
                        } else {
                            htmlOptins = htmlOptins
                                + "<option value='" + value.delivery + "'>" + value.title + "</option>";
                        }
                    });
                    $('#select-delivery').html(htmlOptins);
                }
                $('#cart-location').html(result.location);
            });
        },
        deliveryAction: function(e) {
                    console.log($('#select-delivery').val());
            var url = "%s/";
            $.getJSON(url + $('#select-delivery').val()).done(function(result) {
                if (result.status == 1) {
                    $('#cart-total-shipping').html(result.data.shipping);
                    $('#cart-total-total').html(result.data.total);
                    var htmlOptins = '';
                    $.each(result.data.payment, function( index, value ) {
                        if (value.status==1) {
                            htmlOptins = htmlOptins
                                + "<option value='" + value.path + "'>"  + value.title + "</option>";
                        }
                    });
                    $('#select-payment').html(htmlOptins);
                }
                $('#cart-delivery').html(result.delivery);
                $('#cart-payment').html(result.payment);
            });
        },
        paymentAction: function(e) {
            var url = "%s/";
            $.getJSON(url + $('#select-payment').val()).done(function(result) {
                if (result.status == 1) {
                    $('#cart-location').html(result.data.location);
                    $('#cart-delivery').html(result.data.delivery);
                    $('#cart-payment').html(result.data.payment);
                }
            });
        },
        makeOrderAction: function (e) {
            e.preventDefault();
            $('#addressFromNew').addClass('d-none');
            
            $('form#order [name=address_delivery_id]').val(%s);
            $('form#order [name=address_invoicing_id]').val(%s);
            $('form#order [name=submit_order_simple]').removeClass('disabled');
            $('form#order [name=submit_order_simple]').removeAttr('title');
            
            $('.selected-address').addClass('d-none');
            
            $(e.target).addClass('d-none');
            $(e.target).parent().parent().find('.selected-address').removeClass('d-none');
        }
    }
    page.init();
})(jQuery)
EOT;
$script = sprintf(
    $script,
    Pi::url($this->url('', ['controller' => 'checkout', 'action' => 'level', 'process' => 'location', 'id' => ''])),
    __('Price : '),
    __('Time : '),
    __('Days'),
    Pi::url($this->url('', ['controller' => 'checkout', 'action' => 'level', 'process' => 'delivery', 'id' => ''])),
    Pi::url($this->url('', ['controller' => 'checkout', 'action' => 'level', 'process' => 'payment', 'id' => ''])),
    isset($addressDelivery['id']) && $addressDelivery['id'] ?: 0,
    isset($addressInvoicing['id']) && $addressInvoicing['id'] ?: 0
);
$this->footScript()->appendScript($script);
?>
<div id="js-order" class="clearfix order-checkout">
    <div class="mb-3">
        <h1><?php _e('Checkout'); ?></h1>
    </div>
    <div class="row clearfix">
        <?php if (isset($cart['type_payment']) && $cart['type_payment'] == 'installment') { ?>
            <div class="alert alert-info" role="alert">
                <h2><?php _e('Terms of payment'); ?></h2>
                <p>
                    <?php echo sprintf(
                        __('You buy products on %s installment by %s payment on each installment and %s per payment'), _number(count($plan) - 2),
                        Pi::api('api', 'order')->viewPrice($this->escape($plan[1]['price'])),
                        Pi::api('api', 'order')->viewPrice($this->escape($plan[0]['price']))
                    ); ?>
                </p>
            </div>
        <?php } ?>
        <?php if (isset($cart['can_pay']) && $cart['can_pay'] == 2) { ?>
            <div class="alert alert-danger" role="alert">
                <?php echo __(
                    'One of your select products or services have variable stock, than your payment option is disable, we will review your order and if your selected products or services be in stock we active payment option and send notification for you'
                ); ?>
            </div>
        <?php } ?>
    </div>
    <div class="clearfix row">
        <div class="col-lg-8 col-md-8">
            <?php if (isset($invalidAddress) && $invalidAddress) { ?>
                <div class="alert alert-dismissable alert-danger text-center">
                    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">Ã—</button>
                    <div class="clearfix"><?php _e('Your address has to be completed. Please, edit it.'); ?></div>
                </div>
            <?php } else { ?>
                <div class="clearfix alert alert-<?php echo empty($addresses) ? 'info' : 'success' ?>" role="alert">
                    <?php /* if (!empty($addresses)) { ?>
                        <p><?php _e('Here are the addresses you have selected for billing and delivery. You can manage them (add, modify, delete) to select others.') ?></p>
                    <?php } else { ?>
                        <p><?php _e('You don\'t have set an address yet. Please create your address we will use for your order. You will be able then to manage several addresses') ?></p>
                    <?php } */ ?>
                </div>
            <?php } ?>
            <div class="clearfix row">
                <div class="col-lg-6 col-md-6">
                    <?php if (isset($formLogin) && !empty($formLogin)) { ?>
                        <div class="mb-3">
                            <h4><?php _e('Register new user account and make order'); ?></h4>
                        </div>
                    <?php } ?>
                    <div class="card">
                        <div class="card-body address-single">
                            <div class="clearfix">
                                <div class="info">
                                    <div class="mb-3">
                                        <span class="fas fa-file"></span> <strong><?php _e('Billing  Address'); ?></strong>
                                        <?php if (!empty($addresses)) { ?>
                                            <a class="modify-address" href="<?php echo Pi::url(
                                                $this->url('', ['controller' => 'checkout', 'action' => 'address-list', 'type' => 'invoicing'])
                                            ) ?>" data-remote="false" data-toggle="modal" data-target="#addressListModal"
                                               data-type="<?php _e('Billing  Address') ?>">
                                                <i class="fas fa-pen"></i> <?php _e('Modify') ?>
                                            </a>
                                        <?php } ?>
                                    </div>
                                    <div class="invoicing-address">
                                        <?php if (empty($addresses)) { ?>
                                            <?php echo $this->form($forms['new'], 'vertical'); ?>
                                        <?php } else { ?>
                                            <div>
                                                <?php _e('Type') ?> :
                                                <?php echo $addressInvoicing['account_type'] == 'none' ? __('ND') : __(ucfirst($addressInvoicing['account_type'])); ?>
                                            </div>
                                            <?php if ($addressInvoicing['account_type'] === 'company') { ?>
                                                <div><?php echo $this->escape($addressInvoicing['company']); ?></div>
                                                <?php if (!empty($addressInvoicing['company_address1'])) { ?>
                                                    <div><?php echo $this->escape($addressInvoicing['company_address1']); ?></div>
                                                <?php } ?>
                                                <?php if (!empty($addressInvoicing['company_address2'])) { ?>
                                                    <div><?php echo $this->escape($addressInvoicing['company_address2']); ?></div>
                                                <?php } ?>
                                                <div>
                                                    <?php if (!empty($addressInvoicing['company_zip_code'])) { ?>
                                                        <?php echo $this->escape($addressInvoicing['company_zip_code']); ?>&nbsp;
                                                    <?php } ?>
                                                    <?php if (!empty($addressInvoicing['company_state'])) { ?>
                                                        <?php echo $this->escape($addressInvoicing['company_state']); ?>&nbsp;
                                                    <?php } ?>
                                                    <?php if (!empty($addressInvoicing['company_city'])) { ?>
                                                        <?php echo $this->escape($addressInvoicing['company_city']); ?>&nbsp;
                                                    <?php } ?>
                                                    <?php if (!empty($addressInvoicing['company_country'])) { ?>
                                                        <?php echo $this->escape($addressInvoicing['company_country']); ?>&nbsp;
                                                    <?php } ?>
                                                </div>
                                                <div><?php echo $this->escape($addressInvoicing['company_id']); ?></div>
                                                <div><?php echo $this->escape($addressInvoicing['company_vat']); ?></div>
                                                <?php if (!empty($addressInvoicing['email'])) { ?>
                                                    <div>
                                                        <?php _e('Email'); ?> :
                                                        <?php echo $this->escape($addressInvoicing['email']); ?>
                                                    </div>
                                                <?php } ?>
                                                <?php if (!empty($addressInvoicing['phone'])) { ?>
                                                    <div>
                                                        <?php _e('Phone'); ?> :
                                                        <?php echo $this->escape($addressInvoicing['phone']); ?>
                                                    </div>
                                                <?php } ?>
                                                <?php if (!empty($addressInvoicing['mobile'])) { ?>
                                                    <div>
                                                        <?php _e('Mobile'); ?> :
                                                        <?php echo $this->escape($addressInvoicing['mobile']); ?>
                                                    </div>
                                                <?php } ?>
                                            <?php } else { ?>
                                                <div>
                                                    <?php echo $this->escape($addressInvoicing['first_name']); ?>&nbsp;<?php echo $this->escape($addressInvoicing['last_name']); ?>
                                                </div>
                                                <?php if (!empty($addressInvoicing['address1'])) { ?>
                                                    <div><?php echo $this->escape($addressInvoicing['address1']); ?></div>
                                                <?php } ?>
                                                <?php if (!empty($addressInvoicing['address2'])) { ?>
                                                    <div><?php echo $this->escape($addressInvoicing['address2']); ?></div>
                                                <?php } ?>
                                                <div>
                                                    <?php if (!empty($addressInvoicing['zip_code'])) { ?>
                                                        <?php echo $this->escape($addressInvoicing['zip_code']); ?>&nbsp;
                                                    <?php } ?>
                                                    <?php if (!empty($addressInvoicing['state'])) { ?>
                                                        <?php echo $this->escape($addressInvoicing['state']); ?>&nbsp;
                                                    <?php } ?>
                                                    <?php if (!empty($addressInvoicing['city'])) { ?>
                                                        <?php echo $this->escape($addressInvoicing['city']); ?>&nbsp;
                                                    <?php } ?>
                                                    <?php if (!empty($addressInvoicing['country'])) { ?>
                                                        <?php echo $this->escape($addressInvoicing['country']); ?>&nbsp;
                                                    <?php } ?>
                                                </div>
                                                <?php if (!empty($addressInvoicing['email'])) { ?>
                                                    <div>
                                                        <?php _e('Email'); ?> :
                                                        <?php echo $this->escape($addressInvoicing['email']); ?>
                                                    </div>
                                                <?php } ?>
                                                <?php if (!empty($addressInvoicing['phone'])) { ?>
                                                    <div>
                                                        <?php _e('Phone'); ?> :
                                                        <?php echo $this->escape($addressInvoicing['phone']); ?>
                                                    </div>
                                                <?php } ?>
                                                <?php if (!empty($addressInvoicing['mobile'])) { ?>
                                                    <div>
                                                        <?php _e('Mobile'); ?> :
                                                        <?php echo $this->escape($addressInvoicing['mobile']); ?>
                                                    </div>
                                                <?php } ?>
                                            <?php } ?>
                                        <?php } ?>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <?php if (isset($formLogin) && !empty($formLogin)) { ?>
                    <div class="col-lg-6 col-md-6">
                        <div class="alert alert-info" role="alert">
                            <?php _e(
                                'If you registered on website before this time and have user account, please login to system and continue ordering, and if you dont have user account here, please fill register new user account and make order form'
                            ); ?>
                        </div>
                        <div class="card">
                            <div class="card-body address-single">
                                <div class="clearfix">
                                    <div class="info">
                                        <div class="mb-3">
                                            <h4><?php _e('Login'); ?></h4>
                                        </div>
                                        <?php echo $this->form($formLogin); ?>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                <?php } ?>
                <?php if (!empty($addresses)) { ?>
                    <div class="col-lg-6 col-md-6">
                        <div class="card">
                            <div class="card-body address-single">
                                <div class="clearfix">
                                    <div class="info">
                                        <div class="clearfix">
                                            <span class="fas fa-map-marker-alt"></span> <strong><?php _e('Delivery address'); ?></strong>
                                            <?php if ($addressInvoicing['id'] != $addressDelivery['id']) { ?>
                                                <a class="modify-address" href="<?php echo Pi::url(
                                                    $this->url('', ['controller' => 'checkout', 'action' => 'address-list', 'type' => 'delivery'])
                                                ) ?>" data-remote="false" data-toggle="modal" data-target="#addressListModal"
                                                   data-type="<?php _e('Delivery address') ?>">
                                                    <i class="fas fa-pen"></i> <?php _e('Modify') ?>
                                                </a>
                                            <?php } ?>
                                        </div>
                                        <div class="delivery-address">
                                            <?php if ($addressInvoicing['id'] == $addressDelivery['id']) { ?>
                                                <a href="<?php echo Pi::url(
                                                    $this->url('', ['controller' => 'checkout', 'action' => 'address-list', 'type' => 'delivery'])
                                                ) ?>" data-remote="false" data-toggle="modal" data-target="#addressListModal"
                                                   data-title="<?php _e('Delivery address') ?>">
                                                    <input type="checkbox" checked="checked"/> <?php _e("Same address"); ?>
                                                </a>
                                            <?php } else { ?>
                                                <?php if (empty($addresses)) { ?>
                                                    <?php echo $this->form($forms['new'], 'vertical'); ?>
                                                <?php } else { ?>
                                                    <div>
                                                        <?php _e('Type') ?> :
                                                        <?php echo $addressDelivery['account_type'] == 'none' ? __('ND') : __(ucfirst($addressDelivery['account_type'])); ?>
                                                    </div>
                                                    <?php if ($addressDelivery['account_type'] === 'company') { ?>
                                                        <div><?php echo $this->escape($addressDelivery['company']); ?></div>

                                                        <?php if (!empty($addressDelivery['company_address1'])) { ?>
                                                            <div><?php echo $this->escape($addressDelivery['company_address1']); ?></div>
                                                        <?php } ?>
                                                        <?php if (!empty($addressDelivery['company_address2'])) { ?>
                                                            <div><?php echo $this->escape($addressDelivery['company_address2']); ?></div>
                                                        <?php } ?>
                                                        <div>
                                                            <?php if (!empty($addressDelivery['company_zip_code'])) { ?>
                                                                <?php echo $this->escape($addressDelivery['company_zip_code']); ?>&nbsp;
                                                            <?php } ?>
                                                            <?php if (!empty($addressDelivery['company_state'])) { ?>
                                                                <?php echo $this->escape($addressDelivery['company_state']); ?>&nbsp;
                                                            <?php } ?>
                                                            <?php if (!empty($addressDelivery['company_city'])) { ?>
                                                                <?php echo $this->escape($addressDelivery['company_city']); ?>&nbsp;
                                                            <?php } ?>
                                                            <?php if (!empty($addressDelivery['company_country'])) { ?>
                                                                <?php echo $this->escape($addressDelivery['company_country']); ?>&nbsp;
                                                            <?php } ?>
                                                        </div>
                                                        <div><?php echo $this->escape($addressDelivery['company_id']); ?></div>
                                                        <div><?php echo $this->escape($addressDelivery['company_vat']); ?></div>
                                                        <?php if (!empty($addressDelivery['email'])) { ?>
                                                            <div>
                                                                <?php _e('Email'); ?> :
                                                                <?php echo $this->escape($addressDelivery['email']); ?>
                                                            </div>
                                                        <?php } ?>
                                                        <?php if (!empty($addressDelivery['phone'])) { ?>
                                                            <div>
                                                                <?php _e('Phone'); ?> :
                                                                <?php echo $this->escape($addressDelivery['phone']); ?>
                                                            </div>
                                                        <?php } ?>
                                                        <?php if (!empty($addressDelivery['mobile'])) { ?>
                                                            <div>
                                                                <?php _e('Mobile'); ?> :
                                                                <?php echo $this->escape($addressDelivery['mobile']); ?>
                                                            </div>
                                                        <?php } ?>
                                                    <?php } else { ?>
                                                        <div>
                                                            <?php echo $this->escape($addressDelivery['first_name']); ?>&nbsp;<?php echo $this->escape($addressDelivery['last_name']); ?>
                                                        </div>
                                                        <?php if (!empty($addressDelivery['address1'])) { ?>
                                                            <div><?php echo $this->escape($addressDelivery['address1']); ?></div>
                                                        <?php } ?>
                                                        <?php if (!empty($addressDelivery['address2'])) { ?>
                                                            <div><?php echo $this->escape($addressDelivery['address2']); ?></div>
                                                        <?php } ?>
                                                        <div>
                                                            <?php if (!empty($addressDelivery['zip_code'])) { ?>
                                                                <?php echo $this->escape($addressDelivery['zip_code']); ?>&nbsp;
                                                            <?php } ?>
                                                            <?php if (!empty($addressDelivery['state'])) { ?>
                                                                <?php echo $this->escape($addressDelivery['state']); ?>&nbsp;
                                                            <?php } ?>
                                                            <?php if (!empty($addressDelivery['city'])) { ?>
                                                                <?php echo $this->escape($addressDelivery['city']); ?>&nbsp;
                                                            <?php } ?>
                                                            <?php if (!empty($addressDelivery['country'])) { ?>
                                                                <?php echo $this->escape($addressDelivery['country']); ?>&nbsp;
                                                            <?php } ?>
                                                        </div>
                                                        <?php if (!empty($addressDelivery['email'])) { ?>
                                                            <div>
                                                                <?php _e('Email'); ?> :
                                                                <?php echo $this->escape($addressDelivery['email']); ?>
                                                            </div>
                                                        <?php } ?>
                                                        <?php if (!empty($addressDelivery['phone'])) { ?>
                                                            <div>
                                                                <?php _e('Phone'); ?> :
                                                                <?php echo $this->escape($addressDelivery['phone']); ?>
                                                            </div>
                                                        <?php } ?>
                                                        <?php if (!empty($addressDelivery['mobile'])) { ?>
                                                            <div>
                                                                <?php _e('Mobile'); ?> :
                                                                <?php echo $this->escape($addressDelivery['mobile']); ?>
                                                            </div>
                                                        <?php } ?>
                                                    <?php } ?>
                                                <?php } ?>
                                            <?php } ?>
                                            <br/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                <?php } ?>
            </div>
        </div>
        <div class="col-lg-4 col-md-4">
            <div class="cart-product">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><?php _e('Your order'); ?></h3>
                    </div>
                    <div class="card-body clearfix">
                        <table class="cart-product-list">
                            <tr>
                                <th class="col-lg-10 col-md-10"><?php _e('Product name') ?></th>
                                <th class="col-lg-2 col-md-2 text-right"><?php _e('Total') ?></th>
                            </tr>
                            <?php $totalDiscount = 0 ?>
                            <?php $count = 0 ?>
                            <?php $countOfProducts = count($cart['product']); ?>
                            <?php if (isset($cart['product']) && count($cart['product'])) { ?>
                                <?php foreach ($cart['product'] as $key => $product) { ?>
                                    <?php
                                    $count++;
                                    $extra           = json_decode($product['extra'], true);
                                    $unconsumedPrice = isset($extra['unconsumedPrice']) ? $extra['unconsumedPrice'] : null;
                                    $product['product_price'] = str_replace(',', '.', $product['product_price']);
                                    ?>
                                    <tr>
                                        <td>
                                            <a href="<?php echo $this->escape($product['details']['productUrl']); ?>" target="_blank">
                                                <?php if ($countOfProducts > 1) { ?>
                                                    <b>#<?php echo $count . ' ' . $product['details']['title']; ?></b>
                                                <?php } else { ?>
                                                    <b><?php echo $product['details']['title']; ?></b>
                                                <?php } ?>
                                            </a>
                                            <?php if (isset($product['tooltip']) && $product['tooltip']) { ?>
                                                <button type="button" class="btn btn-tooltip tooltip-description d-inline float-none m-0" data-toggle="tooltip" data-placement="left" title="" data-original-title="<?php echo strip_tags($product['tooltip_description']) ?>">?</button>
                                            <?php } ?>
                                            <?php if (!empty($product['time_start'])) { ?>
                                                <p>
                                                    <?php if ($product['time_end'] == strtotime("2030-01-01")) { ?>
                                                        <?php echo __('Unlimited from') . ' ' . _date($product['time_start']) ?>
                                                    <?php } else { ?>
                                                        <?php echo __('From') . ' ' . _date($product['time_start']) . ' ' . __('to') . ' ' . _date($product['time_end']) ?>
                                                    <?php } ?>
                                                </p>
                                            <?php } ?>
                                            <?php if (!empty($product['details']['thumbUrl'])) { ?>
                                                <div class="col-5">
                                                    <a href="<?php echo $this->escape($product['details']['productUrl']); ?>" target="_blank">
                                                        <img class="img-fluid" src="<?php echo $this->escape($product['details']['thumbUrl']); ?>">
                                                    </a>
                                                </div>
                                            <?php } ?>
                                        </td>
                                        <td class="text-right">
                                            <strong class="data-total-price">
                                                <?php echo Pi::api('api', 'order')->viewPrice($this->escape($product['product_price'] - $product['discount_price'] - $unconsumedPrice)); ?>
                                            </strong>
                                        </td>
                                    </tr>
                                    <?php if ($unconsumedPrice || (isset($product['discount']) && $product['discount'] > 0)) { ?>
                                        <tr>
                                            <td><?php echo "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" . __('Base Price ex VAT'); ?></td>
                                            <td class="data-normal-price">
                                                <?php echo Pi::api('api', 'order')->viewPrice($this->escape($product['product_price'])); ?>
                                            </td>
                                        </tr>
                                    <?php } ?>
                                    <?php if (isset($product['discount']) && $product['discount'] > 0) { ?>
                                        <tr>
                                            <td>
                                                <?php echo "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" . __('Total Discount'); ?>
                                                <?php if (isset($product['discount'])) { ?>
                                                    (<span data-discount-for="<?php echo $product['product'] ?>"><?php echo $product['discount'] ?></span>%)
                                                <?php } ?>
                                            </td>
                                            <td data-discount-price-for="<?php echo $product['product'] ?>">
                                                <?php
                                                echo $product['discount_price'] > 0 ? '-' : '';
                                                echo Pi::api('api', 'order')->viewPrice($this->escape($product['discount_price']));
                                                ?>
                                            </td>
                                        </tr>
                                    <?php } ?>
                                    <?php if ($unconsumedPrice) { ?>
                                        <tr>
                                            <td>
                                                <?php echo "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" . __('Old package recovery'); ?>
                                            </td>
                                            <td data-discount-price-for="<?php echo $product['product'] ?>">
                                                <?php
                                                echo $unconsumedPrice > 0 ? '-' : '';
                                                echo Pi::api('api', 'order')->viewPrice($this->escape($unconsumedPrice));
                                                ?>
                                            </td>
                                        </tr>
                                    <?php } ?>
                                    <?php $totalDiscount += $product['discount_price']; ?>
                                    <?php $totalDiscount += $unconsumedPrice; ?>
                                <?php } ?>
                            <?php } ?>
                            <tr class="footer">
                                <td>
                                    <strong>
                                        <?php //_e('Total Price ext VAT'); ?>
                                        <?php _e('Price'); ?>
                                    </strong>
                                </td>
                                <td class="text-right">
                                    <strong class="data-total-price">
                                        <?php echo Pi::api('api', 'order')->viewPrice(($price['product'] - $totalDiscount) / 1.1); ?>
                                    </strong>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <strong>
                                        <?php //_e('Total Vat'); ?>
                                        <?php _e('GST'); ?>
                                        <?php if (isset($product['vat'])) { ?>
                                            (<?php echo $product['vat'] ?>%)
                                        <?php } ?>
                                    </strong>
                                </td>
                                <td class="text-right">
                                    <strong class="data-total-vat">
                                        <?php echo Pi::api('api', 'order')->viewPrice(
                                            ($price['product'] - $totalDiscount) - (($price['product'] - $totalDiscount) / 1.1)
                                        ); ?>
                                    </strong>
                                </td>
                            </tr>
                            <?php if ($price['shipping'] > 0) { ?>
                                <tr>
                                    <td><?php _e('Total Shipping'); ?></td>
                                    <td class="text-right">
                                        <?php echo Pi::api('api', 'order')->viewPrice($this->escape($price['shipping'])); ?>
                                    </td>
                                </tr>
                            <?php } ?>
                            <?php if (isset($cart['type_payment']) && $cart['type_payment'] != 'installment') { ?>
                                <tr class="card-footer footer">
                                    <td>
                                        <strong>
                                            <?php _e('Total Price'); ?>
                                        </strong>
                                    </td>
                                    <td class="text-right">
                                        <span class="badge badge-success data-total-price-ttc">
                                            <?php echo Pi::api('api', 'order')->viewPrice($this->escape($price['total'])); ?>
                                        </span>
                                    </td>
                                </tr>
                            <?php } ?>
                        </table>
                    </div>
                </div>
                <div class="clearfix">
                    <?php if (isset($forms['promoCheckout'])) { ?>
                        <div class="card mb-3 bg-light">
                            <div class="card-body">
                                <?php echo $this->form()->openTag($forms['promoCheckout']); ?>
                                <div class="clearfix row">
                                    <div class="col-lg-7 col-md-7 col-12 nopadding">
                                        <div class="form-group" data-name="code">
                                            <label class="col-form-label">
                                                <?php _e('Your promo code') ?>
                                            </label>
                                            <?php echo $this->formElement($forms['promoCheckout']->get('code')); ?>
                                            <span class="glyphicon form-control-feedback" aria-hidden="true"></span>
                                        </div>
                                    </div>
                                    <div class="col-lg-3 col-md-3 col-12 nopadding">
                                        <label class="col-form-label">
                                            &nbsp;
                                        </label>
                                        <div class="form-group" data-name="code">
                                            <?php echo $this->formElement($forms['promoCheckout']->get('submit_promo')); ?>
                                        </div>
                                    </div>
                                </div>
                                <?php echo $this->form()->closeTag($forms['promoCheckout']); ?>
                                <div class="clearfix alert d-none" role="alert">
                                    <span></span>
                                </div>
                            </div>
                        </div>
                    <?php } ?>
                    <?php if (isset($forms['order'])) { ?>
                        <?php echo $this->form($forms['order'], 'vertical'); ?>
                    <?php } ?>
                    <?php if ($totalDiscount) { ?>
                        <div class="text-loyalty">
                            <?php _e('You can benefit from a discount loyalty price for this package. The system did apply it on the final price for you.'); ?>
                        </div>
                    <?php } ?>
                </div>
                <?php if (!empty($config['text_description_checkup'])) { ?>
                    <div class="checkout-description">
                        <?php echo $config['text_description_checkup']; ?>
                    </div>
                <?php } ?>
            </div>
        </div>
    </div>
</div>



<div class="modal fade" id="addressListModal" tabindex="-1" aria-labelledby="addressListLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">&nbsp;</h2>
                <button type="button" class="close" data-dismiss="modal" aria-label="<?php _e('Close'); ?>">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-6 text-center">
                        <h3 class="delivery hide mb-3"><?php _e('Delivery Address') ?></h3>
                        <a class="btn btn-simple btn-sm col-lg-12 col-md-12 delivery hide  mb-3"
                           href="<?php echo $this->url('', ['controller' => 'checkout', 'action' => 'address', 'id' => 'delivery']); ?>" data-remote="false"
                           data-toggle="modal" data-dismiss="modal" data-target="#addressModal"><?php _e('Add an delivery address'); ?></a>
                    </div>
                    <div class="col-6 text-center">
                        <h3 class="invoicing hide  mb-3"><?php _e('Billing  Address') ?></h3>
                        <a class="btn btn-simple btn-sm col-lg-12 col-md-12 invoicing hide  mb-3"
                           href="<?php echo $this->url('', ['controller' => 'checkout', 'action' => 'address', 'id' => 'invoicing']); ?>" data-remote="false"
                           data-toggle="modal" data-dismiss="modal" data-target="#addressModal"><?php _e('Add an billing  Address'); ?></a>
                    </div>
                </div>
                <hr />
                <div class="address-list">
                    <?php _e('Please, wait ...') ?>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="addressModal" tabindex="-1" role="dialog" style="overflow-y: auto !important;">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">&nbsp;</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="<?php _e('Close'); ?>">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="address-list">
                    <?php _e('Please, wait ...') ?>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal"><?php _e('Cancel') ?></button>
                <button type="button" class="btn btn-primary edit-address"><?php _e('Save') ?></button>
            </div>
        </div>
    </div>
</div>

<script>
  var needReload = false;
  $(document).ready(function () {

    // Fix for bootstrap bug. When you open 2 modals (first open second), there no scrollbar
    $('body').on('hidden.bs.modal', function () {
      if ($('.modal.show').length > 0) {
        $('body').addClass('modal-open');
      } else {
        if (needReload) {
          $('.invoicing-address').html("<?php _e('Please wait ...') ?>");
          $('.delivery-address').html("<?php _e('Please wait ...') ?>");
          window.location.reload();
        }
      }
    });

    $("#addressModal").on("show.bs.modal", function (e) {
      if ($(e.relatedTarget).length == 0) {
        return;
      }

      var link = $(e.relatedTarget);
      $(this).find(".modal-body .address-list").load(link.attr("href"));
    });

    $("#addressListModal").on("show.bs.modal", function (e) {
      if ($(e.relatedTarget).length == 0) {
        return;
      }

      var link = $(e.relatedTarget);
      $(this).find(".modal-body .address-list").load(link.attr("href"));
      $(this).find('.invoicing').addClass('hide');
      $(this).find('.delivery').addClass('hide');
    });

    $('#promoCheckout').on('submit', function () {
      var code = $('#promoCheckout input[name=code]').val();
      if (code == null) {
        return false;
      }
      $('#promoCheckout input[name=code]').val('');

      $.ajax({
        type: "POST",
        url: "<?php echo Pi::url($this->url('', ['controller' => 'checkout', 'action' => 'promocode'])) ?>",
        data: {code: code},
        success: function (data) {
          window.location.reload();
          /* $('#promoCheckout').parent().find('.alert')
              .removeClass('d-none')
              .removeClass('alert-info')
              .removeClass('alert-success')
              .addClass('alert-' + data.msgPromoCode.type);

          $('#promoCheckout').parent().find('.alert span').html(data.msgPromoCode.message);

          var totalDiscount = 0;
          $.each(data.cart.product, function (i, product) {
                  console.log(product);
                  $('.cart-product span[data-discount-for=' + product.product + ']').html(product.discount);
                  $('.cart-product td[data-discount-price-for=' + product.product + ']').html('-' + product.discount_price_view);
              }
          );
          $('.cart-product .data-total-price').html(data.price.total_price_view);
          $('.cart-product .data-total-vat').html(data.price.vat_view);
          $('.cart-product .data-total-price-ttc').html(data.price.total_price_ttc_view);
          //$('[data-total-vat-for=445]').val() */
        },
        dataType: 'json'
      });
      return false;
    });

    $('.fortooltip').tooltip({container: 'body', html: true});
    $('.fortooltip').click(
      function (e) {
        e.preventDefault();
      }
    );

    $('form#order').submit(
      function () {
        if ($('.submit_order_simple').hasClass('disabled')) {
          return false;
        }

        $('.submit_order_simple').addClass('disabled');
        return true;
      }
    );

    $('.tooltip-description').tooltip();
    var accountTypeChange = function() {

      var show = $('[name=account_type]:checked').val() == 'company';
      var elements = [
        'company',
        'company_address1',
        'company_zip_code',
        'company_city',
        'company_state',
        'company_country',
        'company_id',
        'company_vat'
      ];
      if (show) {
        for (var i = 0; i < elements.length; ++i) {
          var element = $('[name=' + elements[i] + ']');
          if (element.length) {
            if (element.closest('.row').find('label i').length) {
              element.attr('required', true);
            }
          }
        }
        $('[name=company]').closest('fieldset').show();
      } else {
        for (var i = 0; i < elements.length; ++i) {
          var element = $('[name=' + elements[i] + ']');
          if (element.length) {
            element.attr('required', false);
          }
        }
        $('[name=company]').closest('fieldset').hide();
      }
    };

    $('[name=account_type]').change(accountTypeChange);
    accountTypeChange();

  });
</script>
